---
title: "Analysis report by drc-ecotox (Î²)"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output: word_document
---

## 0. Test type
```{r ,echo=FALSE}
if(input$test_type == 'TG201'){
  print("Test No. 201: Freshwater Alga and Cyanobacteria, Growth Inhibition Test")
}else if(input$test_type == 'TG202') {
  print("Test No. 202: Daphnia sp. Acute Immobilisation Test")
} else if(input$test_type == 'TG203') {
  print("Test No. 203: Fish, Acute Toxicity Test")
} else if(input$test_type == 'TG218') {
  print("Test No. 218: Sediment-Water Chironomid Toxicity Using Spiked Sediment or Test No. 219: Sediment-Water Chironomid Toxicity Using Spiked Water")
} else if(input$test_type == 'TG235') {
  print("Test No. 235: Chironomus sp., Acute Immobilisation Test")
}
```
  

## 1. Summary of input data
```{r data, collapse=TRUE, echo=FALSE}
# Check mean and sd at each concentration
if(input$test_type == 'TG202' | input$test_type == 'TG235'){
  filedata()
}else if(input$test_type == 'TG203') {
  filedata() %>%
  group_by(CONC,TIME) %>% 
  summarize_at(vars(-BEAKER),.funs= c(mean,sd)) %>%
  rename(TOTAL_mean = TOTAL_fn1, TOTAL_sd =TOTAL_fn2, IMMOBILIZED_mean = IMMOBILIZED_fn1, IMMOBILIZED_sd = IMMOBILIZED_fn2)
}
```

## 2. Fitting the selected model 
```{r model, collapse=TRUE, echo=FALSE}
# show the selected model
if(input$test_type == 'TG201'){
  if(input$model_TG201 =='ll2'){
  print("Selected model: Log-logistic 2 parameters")
  } else if (input$model_TG201 =='ll4'){
    print("Selected model: Log-logistic 4 parameters")
    }
} else if(input$test_type == 'TG235'){
  if(input$model_TG235 =='ll2'){
  print("Selected model: Log-logistic 2 parameters")
  } else if (input$model_TG235 =='ll4'){
    print("Selected model: Log-logistic 4 parameters")
    }
}
cat("\n\n")
print(" ")
print(ECx())
```

## 3. Dose-response plot
```{r plot, collapse=TRUE, echo=FALSE, width = 12, height = 9 }
 if(input$test_type == 'TG201') {
      par(mar=c(5,9,2,2),mgp=c(3, 1, 0))
      plot(fitmodel(), log="x", broken=TRUE, xlab=paste0("Concentration (", input$conc_unit, ")"), ylab="",
             cex=2,cex.axis =2, cex.lab=2)
      } else if(input$test_type == 'TG202') {
      fit <- fitmodel()
      fit1 <- fit$fit1
      fit2 <- fit$fit2
      par(mar=c(5,9,2,2),mgp=c(3, 1, 0))
      plot(fit1, log="x", broken=TRUE, xlab=paste0("Concentration (", input$conc_unit, ")"), ylab="Mortality", 
           ylim=c(0,1),lty="dotted",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      par(new=TRUE)
      plot(fit2, log="x", broken=TRUE, xlab="", ylab="", main="",
           ylim=c(0,1), col="#D55E00",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      legend("topleft",inset=0.05, legend = c("24 h","48 h"), col = c("black","#D55E00"), lty = c("dotted","solid"),cex=1.5)
    } else if(input$test_type == 'TG203') {
      fit <- fitmodel()
      fit1 <- fit$fit1
      fit2 <- fit$fit2
      fit3 <- fit$fit3
      fit4 <- fit$fit4
      par(mar=c(5,9,2,2),mgp=c(3, 1, 0))
      plot(fit1, log="x", broken=TRUE, xlab=paste0("Concentration (", input$conc_unit, ")"), ylab="Mortality", 
           ylim=c(0,1),lty="dotted",cex=2,cex.axis =1.5, cex.lab=1.5)
      par(new=TRUE)
      plot(fit2, log="x", broken=TRUE, xlab="", ylab="", main="",
           ylim=c(0,1), col="#D55E00",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      par(new=TRUE)
      plot(fit3, log="x", broken=TRUE, xlab="", ylab="", main="",
           ylim=c(0,1), lty="dotted", col="tomato",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      par(new=TRUE)
      plot(fit4, log="x", broken=TRUE, xlab="", ylab="", main="",
           ylim=c(0,1), col="black",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      legend("topleft",inset=0.05, legend = c("24 h","48 h","72 h","96 h"), col = c("black","#D55E00","tomato","black"), lty = c("dotted","solid","dotted","solid"),cex=1.5)
    } else if(input$test_type == 'TG235') {
      fit <- fitmodel()
      fit1 <- fit$fit1
      fit2 <- fit$fit2
      par(mar=c(5,9,2,2),mgp=c(3, 1, 0))
      plot(fit1, log="x", broken=TRUE, xlab=paste0("Concentration (", input$conc_unit, ")"), ylab="Immobility",
           ylim=c(0,1),lty="dotted",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      par(new=TRUE)
      plot(fit2, log="x", broken=TRUE, xlab="", ylab="", main="",
           ylim=c(0,1), col="#D55E00",cex=1.5,cex.axis =1.5, cex.lab=1.5)
      legend("topleft",inset=0.05, legend = c("24 h","48 h"), col = c("black","#D55E00"), lty = c("dotted","solid"),cex=1.5)
    }
```

## 4. Session Info
```{r sessionInfo}
sessionInfo()
```
